#!/usr/bin/env bash

include_header build

rdo_build() {
  local build_args=()
  local arg_repository="${RDO_REPOSITORY:?Not in rdo bash session.}"
  local arg_rebuild=
  local arg_tag_append=

  # eval "$(args::init_subcommand "rdo build" "Build project.")"

  # args::new_option "compiler" string "c" "Select the compiler to use" \
  #                  'build_args+=("--build-arg" "COMPILER=${args__1}")'
  # args::new_option "dry-run" empty "" "Do not actually build the container" \
  #                  'build_args+=("--dry-run")'
  # args::new_option "rebuild" empty "" "Rebuild all base images" \
  #                  'build_args+=("--rebuild"); arg_rebuild="yes"'

  # args::new_command "all" empty "Build all" \
  #                   'rdo_build_all "${@}"'
  # args::new_command "check" empty "Build check" \
  #                   'rdo_build_check "${@}"'
  # args::new_command "compile" empty "Build compile" \
  #                   'rdo_build_compile "${@}"'

  # args::new_command "libtorrent" empty "Build libtorrent" \
  #                   'rdo_build__libtorrent "${@}"'
  # args::new_command "libtorrent-compile" empty "Build libtorrent-compile" \
  #                   'rdo_build__libtorrent_compile "${@}"'
  # args::new_command "libtorrent-dev" empty "Build libtorrent-dev" \
  #                   'rdo_build_libtorrent_dev "${@}"'
  # args::new_command "rtorrent" empty "Build rtorrent" \
  #                   'rdo_build__rtorrent "${@}"'
  # args::new_command "rtorrent-compile" empty "Build rtorrent-compile" \
  #                   'rdo_build__rtorrent_compile "${@}"'
  # args::new_command "rtorrent-dev" empty "Build rtorrent-dev" \
  #                   'rdo_build_rtorrent_dev "${@}"'

  # eval "$(args::process)"

  while true; do
    case "${1}" in
      --compiler)
        local args__1="${2:?Missing argument for '${1}'.}"
        shift 2
        build_args+=("--build-arg" "COMPILER=${args__1}")
        ;;
      --dry-run)
        shift
        build_args+=("--dry-run")
        ;;
      --rebuild)
        shift
        build_args+=("--rebuild"); arg_rebuild="yes"
        ;;
      --help|-h|'')
        echo "Usage: rdo build COMMAND"
        echo
        echo "Build project."
        echo
        echo "Options:"
        echo "  -c, --compiler       Select the compiler to use"
        echo "      --dry-run        Do not actually build the container"
        echo "      --rebuild        Rebuild all base images"
        echo
        echo "Commands:"
        echo "  all                  Build all"
        echo "  check                Build check"
        echo "  compile              Build compile"
        echo "  libtorrent           Build libtorrent"
        echo "  libtorrent-compile   Build libtorrent-compile"
        echo "  libtorrent-dev       Build libtorrent-dev"
        echo "  rtorrent             Build rtorrent"
        echo "  rtorrent-compile     Build rtorrent-compile"
        echo "  rtorrent-dev         Build rtorrent-dev"
        echo
        echo "Run 'rdo build COMMAND --help' for more information on a command."
        exit 0
        ;;
      *)
        if [[ -z "${1##-*}" ]]; then
          print_error "${args__root}: unknown flag: ${1}"
          return 1
        fi

        break
        ;;
    esac
  done

  local args__root="rdo build"
  local args__cmd="${1}"
  shift || :

  case "${args__cmd}" in
    all)
        args::verify_command_empty "${@}"
        rdo_build_all "${@}"
      ;;
    check)
        args::verify_command_empty "${@}"
        rdo_build_check "${@}"
      ;;
    compile)
        args::verify_command_empty "${@}"
        rdo_build_compile "${@}"
      ;;
    libtorrent)
        args::verify_command_empty "${@}"
        rdo_build__libtorrent "${@}"
      ;;
    libtorrent-compile)
        args::verify_command_empty "${@}"
        rdo_build__libtorrent_compile "${@}"
      ;;
    libtorrent-dev)
        args::verify_command_empty "${@}"
        rdo_build_libtorrent_dev "${@}"
      ;;
    rtorrent)
        args::verify_command_empty "${@}"
        rdo_build__rtorrent "${@}"
      ;;
    rtorrent-compile)
        args::verify_command_empty "${@}"
        rdo_build__rtorrent_compile "${@}"
      ;;
    rtorrent-dev)
        args::verify_command_empty "${@}"
        rdo_build_rtorrent_dev "${@}"
      ;;
    *)
      print_error "rdo build: unknown command: ${args__cmd}"
      exit 1
      ;;
  esac
}

rdo_build_all() {
  rdo init verify
  rdo_build__init
  rdo_build__libtorrent_configure
  rdo_build__libtorrent_compile
  rdo_build__rtorrent_configure
  rdo_build__rtorrent_compile
  rdo_build__rtorrent_run
}

rdo_build_check() {
  rdo init verify
  rdo_build__libtorrent_check "${@}"
  rdo_build__rtorrent_check "${@}"
}

rdo_build_compile() {
  rdo init verify
  rdo_build__libtorrent_compile "${@}"
  rdo_build__rtorrent_compile "${@}"
  rdo_build__rtorrent_run
}

rdo_build_libtorrent_dev() {
  rdo init verify

  local image_tag="${arg_repository}/build/libtorrent-stage:default"
  local container_name="rdo-build-libtorrent"

  if [[ "${arg_rebuild}" == "yes" ]] || [[ -z "$(rdo__running_container_id__name "${container_name}")" ]]; then
    rdo_build__init
    rdo_build__libtorrent_configure
    print_space
    rdo run init --rebuild "${image_tag}" "${container_name}"
    print_space
  fi

  docker exec "${container_name}" build-all libtorrent
}

rdo_build_rtorrent_dev() {
  rdo init verify

  local image_tag="${arg_repository}/build/rtorrent-stage:default"
  local container_name="rdo-build-rtorrent"

  if [[ "${arg_rebuild}" == "yes" ]] || [[ -z "$(rdo__container_id__name "${container_name}")" ]]; then
    rdo_build__init
    rdo_build__libtorrent_configure
    rdo_build__libtorrent_compile
    rdo_build__rtorrent_configure
    print_space
    rdo run init --rebuild "${image_tag}" "${container_name}"
    print_space
  fi

  docker exec "${container_name}" build-all rtorrent
}

# Helper functions

rdo_build__build() {
  local build_all_args=("${@}")
  local build_option_args=("${build_all_args[@]:0:${#@}-1}")
  local build_tag="${build_all_args[-1]}"

  if [[ -z "${arg_tag_append}" ]] && [[ ! "${build_tag}" =~ : ]]; then
    build_option_args+=("--tag-append" "default")
  fi

  rdo docker context build "${build_option_args[@]}" "${build_args[@]}" "${build_tag}"
}

rdo_build__compile_status() {
  local context_name="${1:?Missing context name argument.}"
  local image_tag="${arg_repository}/${2:?Missing image tag argument.}"

  if [[ ! "${build_tag}" =~ : ]]; then
    image_tag+=":default"
  fi

  local file_prefix="/deploy/${context_name}/output/status"

  if rdo__image_has_file "${image_tag}" "${file_prefix}.success"; then
    echo "success"
  elif rdo__image_has_file "${image_tag}" "${file_prefix}.failure"; then
    echo "failure"
  else
    print_error "could not get compile status for ${image_tag}"
    return 1
  fi
}

rdo_build__check_compile() {
  local context_name="${1:?Missing context name argument.}"

  if [[ "$(rdo_build__compile_status "libtorrent" "build/stage")" == "success" ]]; then
    print_progress "compile success"
  else
    print_warning "compile failed"
    return 1
  fi
}

rdo_build__init() {
  rdo docker pull "docker/dockerfile:experimental" "alpine:latest"

  rdo_build__build --context-type "ancestor" --context-name "ancestor" --no-rebuild --ancestor-project "rdo-pkg-cache" "ancestor/cache:global"
  rdo_build__build --empty --no-rebuild "cache/apk:global"

  rdo_build__build --context-type "ancestor" --context-name "ancestor" --cache --no-rebuild --ancestor-project "rdo-project" "ancestor:global"
  rdo_build__build --empty --no-rebuild "stage:global"
  rdo_build__build --empty --cache "base/build/compiler"
  rdo_build__build --empty --cache "base/build/rtorrent"
  rdo_build__build --empty "base/run/rtorrent"

  rdo_build__build --context-type "autogen" --filename "build.autogen" --build-arg "STAGE_TAG=build/stage" "build/stage"
}

ordo_build__libtorrent() {
  rdo_build__libtorrent_configure
  rdo_build__libtorrent_compile
}

rdo_build__libtorrent_configure() {
  rdo_build__build --context-type "compile" --context-name "libtorrent" --filename "build.libtorrent.configure" "build/stage"
}

rdo_build__libtorrent_compile() {
  rdo_build__build --context-type "compile" --context-name "libtorrent" --filename "build.libtorrent.compile" --build-arg "IGNORE_BUILD_ERROR=yes" "build/stage"
  rdo_build__check_compile "libtorrent"
}

rdo_build__rtorrent_configure() {
  rdo_build__build --context-type "compile" --context-name "rtorrent" --filename "build.rtorrent.configure" "build/stage"
}

rdo_build__rtorrent_compile() {
  rdo_build__build --context-type "compile" --context-name "rtorrent" --filename "build.rtorrent.compile" --build-arg "IGNORE_BUILD_ERROR=yes" "build/stage"
  rdo_build__check_compile "rtorrent"
}

rdo_build__rtorrent_run() {
  rdo_build__build --context-type "run" --context-name "rtorrent" "run/rtorrent"
}

rdo_build__libtorrent_check() {
  rdo init verify

  local image_tag="${arg_repository}/build/libtorrent-stage:default"
  local container_name="rdo-check-libtorrent"

  if [[ "${arg_rebuild}" == "yes" ]] || [[ -z "$(rdo__running_container_id__name "${container_name}")" ]]; then
    rdo_build__init
    rdo_build__libtorrent_configure
    rdo_build__libtorrent_compile
    print_space
    rdo run init --rebuild "${image_tag}" "${container_name}"
    print_space
  fi

  docker exec "${container_name}" build-check libtorrent
}

rdo_build__rtorrent_check() {
  rdo init verify

  local image_tag="${arg_repository}/build/rtorrent-stage:default"
  local container_name="rdo-check-rtorrent"

  if [[ "${arg_rebuild}" == "yes" ]] || [[ -z "$(rdo__running_container_id__name "${container_name}")" ]]; then
    rdo_build__init
    rdo_build__libtorrent_configure
    rdo_build__libtorrent_compile
    rdo_build__rtorrent_configure
    rdo_build__rtorrent_compile
    print_space
    rdo run init --rebuild "${image_tag}" "${container_name}"
    print_space
  fi

  docker exec "${container_name}" build-check rtorrent
}

