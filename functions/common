#!/usr/bin/env bash

rdo_header common

rdo__compare_id__file_image() {
  local file_name="${1:?Missing file argument.}"
  local image_name="${2:?Missing image argument.}"

  if ! [[ -f "${file_name}" ]]; then
    return 1
  fi

  local file_id="$(cat "${file_name}")"
  local image_id="$(rdo docker inspect --id "${image_name}")"

  [[ -n "${file_id}" ]] && [[ "${file_id}" == "${image_id}" ]]
}

# TODO: Restrict to label.
rdo__container_id__name() {
  local container_name="${1:?Missing container name argument.}"
  echo "$(docker container inspect --format '{{ .Id }}' "${container_name}" 2> /dev/null)"
}

# TODO: Add lookup that only take tags or id's
rdo__image_id() {
  local image_name="${1:?Missing image argument.}"
  echo "$(rdo docker inspect --id "${image_name}" 2> /dev/null)"
}

rdo__image_id__tag() {
  local image_name="${1:?Missing image argument.}"
  echo "$(rdo docker inspect --id "${image_name}" 2> /dev/null)"
}

rdo__latest_image_id__label() {
  local label="${1:?Missing label argument.}"
  local image_id="$(docker images --all --quiet --filter label=${label} | head -n1)"

  if [[ -n "${image_id}" ]]; then
    rdo__image_id "${image_id}"
  fi
}

rdo__compare_hash__dir_dir() {
  local path_lhs="${1:?Missing lhs path argument.}"
  local path_rhs="${2:?Missing rhs path argument.}"

  # Sort by size to detect if any files are empty or incomplete.

  if [[ "${path_lhs}" =~ : ]]; then
    local hash_lhs="$(docker exec "${path_lhs%%:*}" sh -c "cd '${path_lhs##*:}'; \ls -S | tail -n +2")"
  else
    local hash_lhs="$(cd "${path_lhs}"; \ls -S | tail -n +2)"
  fi

  if [[ "${path_rhs}" =~ : ]]; then
    local hash_rhs="$(docker exec "${path_rhs%%:*}" sh -c "cd '${path_rhs##*:}'; \ls -S | tail -n +2")"
  else
    local hash_rhs="$(cd "${path_rhs}"; \ls -S | tail -n +2)"
  fi

  [[ "${hash_lhs}" == "${hash_rhs}" ]]
}

# Move:

rdo__project_absolute_unix_path() {
  if [[ -z "${PROJECT_ABSOLUTE_UNIX_PATH}" ]]; then
    if [[ "${OSTYPE}" == "cygwin" ]]; then
      PROJECT_ABSOLUTE_UNIX_PATH="$(cd "${PROJECT_PATH}" && cygpath -au .)"
      PROJECT_ABSOLUTE_UNIX_PATH="/cygwin64${PROJECT_ABSOLUTE_UNIX_PATH%/}"
    else
      PROJECT_ABSOLUTE_UNIX_PATH="$(cd "${PROJECT_PATH}" && pwd)"
    fi
  fi

  echo "${PROJECT_ABSOLUTE_UNIX_PATH}"
}
