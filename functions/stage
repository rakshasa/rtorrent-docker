#!/usr/bin/env bash

include_header stage

rdo_stage() {
  local project_path
  project_path="$(get_project_path)"

  # eval "$(args::init_subcommand "rdo stage" "Manage staging of environments.")"

  # args::new_command "clean" empty "Remove environment" \
  #                   'rdo_stage_clean "${@}"'
  # args::new_command "init" empty "Initialize new environment for staging" \
  #                   'rdo_stage_init "${@}"'
  # args::new_command "network" default "Add network" \
  #                   'rdo_stage_network "${@}"'
  # args::new_command "node" default "Add node" \
  #                   'rdo_stage_node "${@}"'
  # args::new_command "test" empty "Stage test environment" \
  #                   'rdo_stage_test "${@}"'

  # eval "$(args::process)"

  while true; do
    case "${1}" in
      --help|-h|'')
        echo "Usage: rdo stage COMMAND"
        echo
        echo "Manage staging of environments."
        echo
        echo "Commands:"
        echo "  clean     Remove environment"
        echo "  init      Initialize new environment for staging"
        echo "  network   Add network"
        echo "  node      Add node"
        echo "  test      Stage test environment"
        echo
        echo "Run 'rdo stage COMMAND --help' for more information on a command."
        exit 0
        ;;
      *)
        if [[ -n "" ]] && [[ -z "${1##-*}" ]]; then
          print_error "${args__root}: unknown flag: ${1}"
          return 1
        fi

        break
        ;;
    esac
  done

  local args__root="rdo stage"
  local args__cmd="${1}"
  shift || :

  case "${args__cmd}" in
    clean)
      args::verify_command_empty "${@}"
      rdo_stage_clean "${@}"
      ;;
    init)
      args::verify_command_empty "${@}"
      rdo_stage_init "${@}"
      ;;
    network)
      rdo_stage_network "${@}"
      ;;
    node)
      rdo_stage_node "${@}"
      ;;
    test)
      args::verify_command_empty "${@}"
      rdo_stage_test "${@}"
      ;;
    *)
      print_error "rdo stage: unknown command: ${args__cmd}"
      exit 1
      ;;      
  esac
}

rdo_stage_test() {
  print_progress "staging test"
  rdo_stage_init
  rdo_stage_network "rt-network-1"
  rdo_stage_network "rt-network-2"
  rdo_stage_node --network "rt-network-1" --network "rt-network-2" "rt-node-1"
  print_progress "staged test"
}

rdo_stage_clean() {
  rdo_node_clean > /dev/null
  rdo_network_clean > /dev/null
  rm -rf "./stage"
  print_progress "stage cleaned"
}

rdo_stage_init() {
  # TODO: Add state, don't allow calls when not in initialize.
  rdo_stage_clean
  mkdir -p "./stage/"{networks,nodes}
  print_progress "stage initialized"
}

rdo_stage_network() {
  eval "$(args::init_options_string "rdo stage network NAME" "name" "Add network to staging of environments.")"
  eval "$(args::process)"

  local path="./stage/networks/${name}"
  mkdir -p "${path}"

  docker network create --label "project=rdo" "${name}" > /dev/null

  echo "$(rdo_network subnet "${name}")" > "${path}/subnet"
  echo "$(rdo_network address "${name}")" > "${path}/address"
  echo "$(rdo_network prefix "${name}")" > "${path}/prefix"

  echo "${name}"
}

rdo_stage_node() {
  local networks=()
  local create_args=()

  eval "$(args::init_options_string "rdo stage node NAME" "name" "Add node to staging of environments.")"

  args::new_option "network" string "n" "Connect node to network" \
                   'networks+=("${args__1}")'

  eval "$(args::process)"

  local path="./stage/nodes/${name}"
  mkdir -p "${path}/"interfaces

  create_args+=(
    --name "${name}"
    --tty
    --network "none"
    --mount "type=bind,source=$(project_absolute_unix_path)/stage/nodes/${name}/,target=/stage/self/"
  )  

  docker container create --label "project=rdo" "${create_args[@]}" "rdo/run/rtorrent:default" > /dev/null
  docker network disconnect "none" "${name}"

  for network in "${networks[@]}"; do
    docker network connect "${network}" "${name}"
  done

  docker start "${name}" > /dev/null

  rdo_stage__update_network

  echo "${name}"
}

# Helper functions

rdo_stage__update_network() {
  local node_path="./stage/nodes/${name}"

  rm -rf "${node_path}/interfaces"

  local line
  while IFS= read -r line; do
    if ! [[ "${line}" =~ ^network:([^ ]*)\ mac:([^ ]*)\ inet:([^ ]*)\ inet6:([^ ]*)$ ]]; then
      print_error "invalid output from 'rdo node network '${name}'"
      continue
    fi

    local network="${BASH_REMATCH[1]:?Missing network name.}"
    local interface_path="${node_path}/interfaces/${network}"
    mkdir -p "${interface_path}"

    [[ -z "${BASH_REMATCH[2]}" ]] || echo "${BASH_REMATCH[2]}" > "${interface_path}/mac"
    [[ -z "${BASH_REMATCH[3]}" ]] || echo "${BASH_REMATCH[3]}" > "${interface_path}/inet"
    [[ -z "${BASH_REMATCH[4]}" ]] || echo "${BASH_REMATCH[4]}" > "${interface_path}/inet6"

  done <<< "$(rdo_node_network "${name}")"
}
