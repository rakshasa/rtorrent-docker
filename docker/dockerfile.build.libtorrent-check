ARG REPOSITORY
ARG TAG_APPEND


FROM "${REPOSITORY}/build/libtorrent-stage:${TAG_APPEND}" AS stage


FROM "${REPOSITORY}/build/libtorrent-base:${TAG_APPEND}"

COPY --from=stage /deploy/build/ /build/
COPY --from=stage /deploy/prefix/ /prefix/

COPY /check/ /stage/
RUN rsync-update /stage/ /build/

RUN echo -e "\033[0;32mcompiling libtorrent tests\033[0m"; set -xe; \
make -j12 check TESTS=

RUN echo -e "\033[0;32mrunning libtorrent tests\033[0m"; set -xe; \
make -j12 check

RUN \
rsync-deploy-compile /build/ /deploy/build/; \
cp -rp /prefix /deploy/
