#!/bin/bash

#
# Test default behavior of rtorrent in various network setttings.
#

# TODO: This test should be removed, and replace with specific test for what is done here.
# TODO: Add test for various download state events.

rdo_test_begin


#
# Topology, trackers and torrents:
#

# TODO: Add test for both v4only and v6only seeders.

rdo_stage_network                "rt-global"
rdo_stage_network --disable-ipv6 "rt-global-v4"
rdo_stage_network --disable-ipv4 "rt-global-v6"

rdo_network_forward --ingress-ipv4 "rt-global-v4" --bridge "rt-global"
rdo_network_forward --ingress-ipv6 "rt-global-v6" --bridge "rt-global"

rdo_stage_dns     --run-template "dns-default"     --network "rt-global" "rt-dns-global"
rdo_stage_tracker --run-template "tracker-default" --network "rt-global" "rt-tracker-global"

rdo_stage_deploy


#
# Seeders:
#

rdo_stage_rtorrent \
  --run-template "rt-default" \
  --dns-inet "rt-dns-global:rt-global" \
  --network "rt-global" \
  "rt-seed-global"

rdo_torrent_create --domain "rt-tracker-global.rt" "torrent-global"
rdo_torrent_node   --seeder "rt-seed-global" "torrent-global"

rdo_stage_deploy
rdo_torrent_wait --print --wait-all \
                 \
                 --hash-done     "rt-seed-global:torrent-global" \
                 --seeding       "rt-seed-global:torrent-global"


#
# Leechers:
#

test_clients=(
  "rt-leech-v4v6-1"
  "rt-leech-v4-"{1..2}
  "rt-leech-v6-"{1..2}
)

default_rtorrent_v4_args=(
  --run-template "rt-default"
  --dns-inet "rt-dns-global:rt-global"
)

default_rtorrent_v6_args=(
  --run-template "rt-default"
  --dns-inet6 "rt-dns-global:rt-global"
)

rdo_stage_rtorrent "${default_rtorrent_v4_args[@]}" --network "rt-global" "rt-leech-v4v6-1"
rdo_stage_rtorrent "${default_rtorrent_v4_args[@]}" --network "rt-global-v4" "rt-leech-v4-"{1..2}
rdo_stage_rtorrent "${default_rtorrent_v6_args[@]}" --network "rt-global-v6" "rt-leech-v6-"{1..2}

rdo_torrent_node $(printf -- " --leecher %s" "${test_clients[@]}") "torrent-global"

rdo_stage_deploy
rdo_torrent_wait --print --wait-all \
                 \
                 $(printf -- " --hash-done %s:torrent-global" "${test_clients[@]}") \
                 $(printf -- " --not-seeding %s:torrent-global" "${test_clients[@]}") \
                 $(printf -- " --completed %s:torrent-global" "${test_clients[@]}")

rdo_test_end
